<!-- app/views/enterprise/projects/show.html.erb -->
<h1><%= @project.title %></h1>

<p><strong>Description:</strong> <%= @project.description %></p>
<p><strong>Budget:</strong> <%= @project.budget %></p>
<p><strong>Start Date:</strong> <%= @project.start_date %></p>
<p><strong>End Date:</strong> <%= @project.end_date %></p>
<p><strong>Status:</strong> <%= @project.status %></p>

<%= link_to 'Back to Projects', enterprise_projects_path(current_user) %>
<%= link_to 'Edit', edit_enterprise_project_path(current_user, @project) %>

<%= simple_form_for @project, url: enterprise_project_path(current_user, @project), method: :delete, html: { data: { confirm: 'Are you sure you want to delete this project?' } } do |f| %>
  <%= f.button :submit, 'Delete', class: 'btn btn-danger' %>
<% end %>

<%# Section pour les évaluations/reviews - uniquement pour les projets terminés %>
<% if current_user == @project.user && @project.completed? %>
  <div class="mt-5 card shadow-sm border-0 rounded-4 bg-white p-4">
    <h3 class="mb-3">Évaluer le(s) freelance(s)</h3>

    <% # Récupérer tous les freelances associés à ce projet via SharedProject %>
    <% freelancers = @project.freelancers %>

    <% if freelancers.any? %>
      <% freelancers.each do |freelancer| %>
        <div class="mb-4 p-3 <%= 'border-bottom' unless freelancer == freelancers.last %>">
          <h5><%= freelancer.first_name %> <%= freelancer.last_name %></h5>

          <% # Vérifier si une review existe déjà pour ce freelance sur ce projet %>
          <% existing_review = Review.find_by(user_id: current_user.id, rated_user_id: freelancer.id, project_id: @project.id) %>

          <% if existing_review.present? %>
            <div class="alert alert-success">
              <p>Vous avez déjà évalué ce freelance pour ce projet.</p>
              <div class="mt-2">
                <% existing_review.score.times do %>
                  <i class="fas fa-star text-warning"></i>
                <% end %>
                <% (5 - existing_review.score).times do %>
                  <i class="far fa-star text-warning"></i>
                <% end %>
                <p class="mt-2"><%= existing_review.comment %></p>
              </div>
            </div>
          <% else %>
            <% # Créer une nouvelle instance de Review pour le formulaire %>
            <% review = Review.new(
               project_id: @project.id,
               user_id: current_user.id,
               rated_user_id: freelancer.id
            ) %>

            <div id="review-form-container">
              <%= simple_form_for review, url: reviews_path, html: { data: { turbo: "true" } } do |f| %>
                <%= f.hidden_field :project_id %>
                <%= f.hidden_field :rated_user_id %>

                <div class="rating-group">
                  <p>Note :</p>
                  <!-- Champ caché pour stocker la note -->
                  <%= f.input :score, as: :hidden, input_html: { value: review.score || 0, data: { star_rating_target: "hiddenInput" } } %>

                  <!-- Conteneur pour les étoiles, géré par le contrôleur Stimulus "star-rating" -->
                  <div class="stars" data-controller="star-rating">
                    <i class="star-icon fas fa-star text-secondary" data-star-rating-target="star" data-value="1" data-action="mouseover->star-rating#highlight click->star-rating#updateRating"></i>
                    <i class="star-icon fas fa-star text-secondary" data-star-rating-target="star" data-value="2" data-action="mouseover->star-rating#highlight click->star-rating#updateRating"></i>
                    <i class="star-icon fas fa-star text-secondary" data-star-rating-target="star" data-value="3" data-action="mouseover->star-rating#highlight click->star-rating#updateRating"></i>
                    <i class="star-icon fas fa-star text-secondary" data-star-rating-target="star" data-value="4" data-action="mouseover->star-rating#highlight click->star-rating#updateRating"></i>
                    <i class="star-icon fas fa-star text-secondary" data-star-rating-target="star" data-value="5" data-action="mouseover->star-rating#highlight click->star-rating#updateRating"></i>
                  </div>
                </div>

                <div class="form-group">
                  <%= f.input :comment, as: :text, label: "Votre commentaire" %>
                </div>

                <%= f.button :submit, "Envoyer l'avis", class: "btn btn-primary" %>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    <% else %>
      <div class="alert alert-info">
        <p>Aucun freelance n'est associé à ce projet. Vous ne pouvez pas laisser d'évaluation.</p>
      </div>
    <% end %>
  </div>
<% end %>

<%# <% if current_user == @project.user %>
  <%# <h3>Share this project with freelancers</h3> %>

  <%# <%= form_with(url: shared_project_path_project_path(@project), method: :post) do |f| %>
    <%# <%= f.select :user_id, User.where(role: 'freelancer').pluck(:email, :id), prompt: 'Select a freelancer' %>
    <%# <%= f.submit "Share Project" %>
  <%# <% end %>
<%# <% end %>
